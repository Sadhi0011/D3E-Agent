# D3E Models Comprehensive Guide

## Introduction

In D3E Studio, **models** are fundamental building blocks that define the structure and characteristics of data within your application. Models act as blueprints for creating, storing, and interacting with information, and are central to both backend and frontend development in D3E.

Models describe the structure of your data, and more than 90% of your backend application is generated by what you describe in these models. Unlike traditional database schemas, D3E describes your data in terms of objects, making it more intuitive and powerful for modern application development.

---

## Types of Models in D3E

D3E supports several types of models, each serving a specific purpose:

| Model Type              | Description                                                                                                                                   | Syntax            |
| ----------------------- | --------------------------------------------------------------------------------------------------------------------------------------------- | ----------------- |
| **Standard Model**      | Represents persistent data stored in the database (e.g., User, Contact, Invoice). Used for CRUD operations and API generation. Default type.  | Default           |
| **Embedded Model**      | Used as a nested, always-present part of another model. Not stored independently; always exists as part of its parent.                        | `embedded true`   |
| **Non-Creatable Model** | Used internally as part of other models, but cannot be created or managed directly via API.                                                   | `creatable false` |
| **Singleton Model**     | Only one instance can exist in the system. Used for application settings or configuration.                                                    | `singleton true`  |
| **Struct**              | Similar to models, but not stored in the database. Used for temporary data transfer (e.g., between server and client, or between components). | N/A               |

---

## D3E Model Syntax

A D3E model is defined using the following structure:

````
(Model Identity) {
    name 'ModelName'
    [package 'package.name']
    [master MasterModel]
    [parent ParentModel]
    [creatable false] // for non-creatable models
    [singleton true]  // for singleton models
    [embedded true]   // for embedded models
    properties [
        {
            name 'PropertyName'
            type Type
            [required true]
            [unique true]
            [collection true]
            [defaultValue `expression`]
            [computed true]
            [computation `expression`]
            [child true]
            [embedded true]
            [inverse true]
            [inverseProperty propertyName]
            [existsIf `expression`]
            [longText true]
            [transient true]
            [description 'Property description']
        }
        // ... more properties
    ]
    [display `expression`] // how the model is displayed
    [actions [
        {
            name 'ActionName'
            [runOn OnCreate|OnUpdate|OnDelete]
            block ```
                // D3E code here
            ```
        }
        // ... more actions
    ]]
    [validations [
        {
            errorMsg 'Error message'
            expression `validation_expression`
        }
        // ... more validations
    ]]
    [needCreatedDate true]
    [needUpdatedDate true]
}
````

### D3E Syntax Rules

- **NO COMMAS**: Never use commas between items in collections or arrays
- **Expressions**: Wrap in backticks: `expression`
- **Code Blocks**: Wrap in triple backticks: `code`
- **Comments**: Not supported in D3E code
- **Identities**: Computed from names using camelCase/PascalCase
- **Optional Fields**: Properties in brackets [ ] are optional

---

## Model Properties

Each model consists of **properties** that define the fields and data types for the model. Properties can have various attributes that control their behavior and usage.

### Property Types

#### Primitive Types

| Type     | Default Value | Description                                                          |
| :------- | :------------ | :------------------------------------------------------------------- |
| String   | null          | For storing small or big text. Everything is stored in UTF8 format   |
| Boolean  | false         | true or false                                                        |
| Integer  | 0             | Mathematical integer. It is 64 bit Signed value                      |
| Double   | 0.0           | Floating point value. 64 bit signed value (always use decimal point) |
| Date     | null          | To represent Date                                                    |
| Time     | null          | To represent Time                                                    |
| DateTime | null          | To represent Date and Time together                                  |
| Duration | null          | Represents time gap between two DateTimes                            |
| DFile    | null          | File uploads                                                         |
| Blob     | null          | Binary data                                                          |

#### Complex Types

| Property Type       | Description                                                                                 |
| ------------------- | ------------------------------------------------------------------------------------------- |
| **Model Reference** | Points to another model, establishing relationships (e.g., User has a reference to Company) |
| **OptionSet**       | Restricts the value to a predefined set of options (like enums)                             |
| **Collection**      | Indicates the property is a list/array of the specified type                                |
| **Embedded**        | The property is always present as part of the parent model and cannot be null               |
| **Computed**        | Value is calculated from other properties using an expression                               |
| **Transient**       | Used for temporary/calculated data, not persisted in the database                           |

---

## Property Attributes

### Common Property Attributes

| Attribute          | Description                                                                              |
| ------------------ | ---------------------------------------------------------------------------------------- |
| **Name**           | The unique identifier for the property within the model                                  |
| **Type**           | The data type of the property (e.g., String, Integer, Boolean, another Model, OptionSet) |
| **Required**       | If true, the property must have a value when creating or updating the model              |
| **Collection**     | If true, the property holds a list of values instead of a single value                   |
| **Default Value**  | The value assigned if none is provided during creation                                   |
| **Reference From** | Indicates a reference to another property or model, establishing relationships           |
| **Exists If**      | Conditional logic to determine if the property should exist based on other values        |
| **Description**    | Human-readable explanation of the property's purpose                                     |
| **Read Type**      | Controls access: Read/Write, Write Once, Read Only, Local                                |
| **Computed**       | The property's value is calculated dynamically from other properties                     |
| **Transient**      | Not stored in the database; used for temporary or calculated values                      |
| **Unique**         | Ensures the property value is unique across all records                                  |

### Special Property Features

#### Computed Properties

```
{
    name 'Full Name'
    type String
    computed true
    computation `firstName + ' ' + lastName`
}
```

#### Default Values

```
{
    name 'Status'
    type String
    defaultValue `'Active'`
}
```

**Important**: Only specify defaultValue for non-default values. Don't use for:

- String: `''` (empty string)
- Integer: `0`
- Double: `0.0`
- Boolean: `false`

#### Conditional Properties

```
{
    name 'Contract Details'
    type String
    existsIf `employmentType == 'Contract'`
}
```

#### Collection Properties

```
{
    name 'Skills'
    type String
    collection true
}
```

#### Long Text Properties

```
{
    name 'Description'
    type String
    longText true
}
```

---

## Model Relationships

### Master-Child Relationships

```
(Model Employee) {
    name 'Employee'
    master Company
    // ...
}
```

### Parent-Child Inheritance

```
(Model Customer) {
    name 'Customer'
    parent BaseUser
    // ...
}
```

### Child/Embedded Objects

```
{
    name 'Address'
    type Address
    child true
}
```

### Inverse Relationships

```
{
    name 'Orders'
    type Order
    collection true
    inverse true
    inverseProperty customer
}
```

---

## Model Validations

### Property Validations

Define rules to check before accepting a given value for a field:

```
validations [
    {
        errorMsg 'Email must be unique'
        expression `email.isUnique()`
    }
    {
        errorMsg 'End date must be after start date'
        expression `endDate > startDate`
    }
]
```

### Model Validations

Cross-field validations that depend on multiple properties:

```
validations [
    {
        errorMsg 'Invoice date should be before due date'
        expression `this.invoiceDate.before(this.dueDate)`
    }
]
```

---

## Model Actions

Actions allow you to execute custom logic on lifecycle events:

````
actions [
    {
        name 'onCreate'
        runOn OnCreate
        block ```
            this.status = 'Active';
            Database.save(this);
        ```
    }
    {
        name 'onUpdate'
        runOn OnUpdate
        block ```
            if(this.status != old.status) {
                // Status changed logic
            }
        ```
    }
    {
        name 'onDelete'
        runOn OnDelete
        block ```
            // Cleanup logic
        ```
    }
]
````

### Action Types (RunOn)

- **OnCreate**: Runs when a new record is created
- **OnUpdate**: Runs when a record is updated
- **OnCreateAndUpdate**: Runs on both create and update
- **OnDelete**: Runs when a record is deleted

---

## Example Models

### Basic Entity Model

```
(Model Customer) {
    name 'Customer'
    properties [
        {
            name 'First Name'
            type String
            required true
        }
        {
            name 'Last Name'
            type String
            required true
        }
        {
            name 'Email'
            type String
            required true
            unique true
        }
        {
            name 'Full Name'
            type String
            computed true
            computation `firstName + ' ' + lastName`
        }
    ]
    display `fullName`
    needCreatedDate true
    needUpdatedDate true
}
```

### Complex Relationship Model

````
(Model Order) {
    name 'Order'
    master Customer
    properties [
        {
            name 'Order Number'
            type String
            required true
            unique true
        }
        {
            name 'Items'
            type OrderItem
            collection true
            child true
        }
        {
            name 'Total Amount'
            type Double
            computed true
            computation `items.fold(0.0, (sum, item) => sum + item.total)`
        }
        {
            name 'Status'
            type OrderStatus
            defaultValue `OrderStatus.Pending`
        }
    ]
    actions [
        {
            name 'calculateTotal'
            runOn OnUpdate
            block ```
                Double total = 0.0;
                for(OrderItem item in items) {
                    total = total + item.total;
                }
                this.totalAmount = total;
            ```
        }
    ]
    needCreatedDate true
    needUpdatedDate true
}
````

### User Model with Authentication

```
(Model User) {
    name 'User'
    parent BaseUser
    properties [
        {
            name 'Username'
            type String
            required true
            unique true
        }
        {
            name 'Email'
            type String
            required true
            unique true
        }
        {
            name 'Password'
            type String
            required true
        }
        {
            name 'Profile'
            type UserProfile
            child true
        }
        {
            name 'Roles'
            type UserRole
            collection true
        }
        {
            name 'Last Login'
            type DateTime
        }
        {
            name 'Is Active'
            type Boolean
            defaultValue `true`
        }
    ]
    validations [
        {
            errorMsg 'Email format is invalid'
            expression `email.contains('@') && email.contains('.')`
        }
    ]
    needCreatedDate true
    needUpdatedDate true
}
```

---

## D3E Code Language Features

- **No "var" keyword**: Declare with type: `String name = 'value';`
- **No "new" keyword**: Create objects: `Customer customer = Customer();`
- **Type safety**: Can't compare Integer and Double
- **Null safety**: Primitives don't hold nulls
- **Switch cases**: No break statements needed
- **Method access**: Use getters like `list.isEmpty` not `list.isEmpty()`

---

## Common Patterns

### Audit Trail

```
needCreatedDate true
needUpdatedDate true
{
    name 'Created By'
    type User
}
{
    name 'Updated By'
    type User
}
```

### Status Management

````
{
    name 'Status'
    type EntityStatus
    defaultValue `EntityStatus.Draft`
}
actions [
    {
        name 'onStatusChange'
        runOn OnUpdate
        block ```
            if(this.status != old.status) {
                // Log status change
                // Send notifications
            }
        ```
    }
]
````

### File Attachments

```
{
    name 'Attachments'
    type DFile
    collection true
}
{
    name 'Main Document'
    type DFile
}
```

---

## Best Practices

1. **Naming**: Use clear, descriptive names for models and properties
2. **Relationships**: Define master-child and inverse relationships properly
3. **Validation**: Add appropriate validations for data integrity
4. **Actions**: Use lifecycle actions for business logic
5. **Computed Properties**: Use for derived values instead of manual calculation
6. **Documentation**: Add descriptions for complex properties
7. **Package Organization**: Group related models in packages
8. **Performance**: Use transient properties for temporary calculations
9. **Type Safety**: Be explicit about types and use proper D3E syntax
10. **Default Values**: Only specify non-default values to avoid redundancy

---

## Summary

Models are the backbone of D3E applications, defining the structure, relationships, and rules for your data. Understanding model types, property attributes, relationships, validations, and actions is essential for effective D3E development. The D3E syntax provides a powerful and intuitive way to describe complex data structures and business logic, making it easier to build robust applications with minimal code.
