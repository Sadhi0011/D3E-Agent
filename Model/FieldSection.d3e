(Model FieldSection {
    name 'Field Section'
    master #Company
    package 'rewahr.com'
    properties [
        (heading {
            name 'Heading'
            type ({
                primitive String
            })
            required true
        })
        (screen {
            name 'Screen'
            type ({
                optionSet #Screen
            })
            required true
        })
        (fields {
            name 'Fields'
            type ({
                model #CustomFieldAvailability
            })
            child true
            collection true
        })
        (sectionField {
            name 'Section Field'
            type ({
                primitive String
            })
        })
    ]
    actions [
        (onCreated {
            name 'On Created'
             block ```
                AddEmployeeWizardSection section = AddEmployeeWizardSection(
                    section: heading,
                );
                AddEmployeeWizardSectionConfiguration wizard = this.company.addEmployeeWizardConfiguration;
                wizard.sections.add(section);
                Database.save(wizard);
             ```
        })
        (onUpdated {
            name 'On Updated'
            runOn OnUpdate
            block ```
                if(heading != old.heading) {
                    AddEmployeeWizardSectionConfiguration wizard = this.company.addEmployeeWizardConfiguration;
                    AddEmployeeWizardSection section = wizard.sections.firstWhere(s => s.section == old.heading);
                    if(section != null) {
                        section.section = heading;
                        Database.save(wizard);
                    }
                }
                List<CustomField> newFields = [];
                List<CustomField> updatedFields = [];
                List<CustomField> deletedFields = [];
                for(CustomFieldAvailability f in this.fields) {
                    if(f.saveStatus == New) {
                        newFields.add(f.field);
                    } else {
                        updatedFields.add(f.field);
                    }
                }
                for(CustomFieldAvailability f in this.old.fields) {
                    if(f.field != null && !updatedFields.contains(f.field)) {
                        deletedFields.add(f.field);
                    }
                }
                if(newFields.isNotEmpty) {
                    AddEmployeeWizardSectionConfiguration wizard = this.company.addEmployeeWizardConfiguration;
                    List<AddEmployeeWizardSection> sections = wizard.sections;
                    AddEmployeeWizardSection section = sections.firstWhere(s => s.section == this.heading);
                    if(section != null) {
                        newFields.forEach((f) {
                            EmployeeWizardSectionField field = EmployeeWizardSectionField(
                                customField: f,
                                required: f.required,
                            );
                            section.fields.add(field);
                        });
                        Database.save(wizard);
                    }
                }
                if(deletedFields.isNotEmpty) {
                    AddEmployeeWizardSectionConfiguration wizard = this.company.addEmployeeWizardConfiguration;
                    List<AddEmployeeWizardSection> sections = wizard.sections;
                    AddEmployeeWizardSection section = sections.firstWhere(s => s.section == this.heading);
                    if(section != null) {
                        deletedFields.forEach((f) {
                            EmployeeWizardSectionField sectionField = section.fields.firstWhere(f1 => f1.customField == f);
                            section.fields.remove(sectionField);
                            Database.delete(f);
                        });
                        Database.save(wizard);
                    }
                }
             ```
        })
        (onDeleted {
            name 'On Deleted'
            runOn OnDelete
            block ```
                for(CustomFieldAvailability f in this.fields) {
                    Database.delete(f.field);
                }
                AddEmployeeWizardSectionConfiguration wizard = this.company.addEmployeeWizardConfiguration;
                AddEmployeeWizardSection section = wizard.sections.firstWhere(s => s.section == heading);
                if(section != null) {
                    this.company.addEmployeeWizardConfiguration.sections.remove(section);
                    Database.save(this.company.addEmployeeWizardConfiguration);
                }
             ```
        })
    ]
})